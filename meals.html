<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="pictures/5.jpg">
    <title>Meals</title>
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link
        href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&amp;family=Poppins:wght@400;700;900&amp;display=swap"
        rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <style type="text/tailwindcss">
        :root {
        --dark-bg: #111111;
        --fiery-red: #ff3838;
        --fiery-red-bg: #ff38380e;
        --fiery-orange: #ff914d;
        --card-bg: #1a1a1a;
      }
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: "Montserrat", sans-serif;
      }
      .font-poppins {
        font-family: "Poppins", sans-serif;
      }
      .container {
        width: 100%;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        padding-bottom: 100px;
      }
      .card {
        width: 100%;
        max-width: 600px;
        min-height: 100vh;
        border-radius: 10px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      }
      .name {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: linear-gradient(
          135deg,
          var(--fiery-red) 0%,
          var(--fiery-orange) 100%
        );
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .progress {
        width: 100%;
        height: 8px;
        background-color: #333;
        border-radius: 4px;
        margin-top: 5px;
        position: relative;
      }
      .progress::before {
        position: absolute;
        content: "";
        background: linear-gradient(to right,var(--fiery-orange),var(--fiery-red));
          height: 100%;
          left: 0;
          top: 0;
          border-radius: 4px;
      }
      .calories-p::before {
        width: 50%;
      }
      .calories-c::before {
        width: 70%;
      }
      .This-week {
        background: linear-gradient(to right,var(--fiery-red),var(--fiery-orange));
      }
      .nav {
        position: fixed;
        bottom: 0;
        width: 100%;
        max-width: 600px;
        left: 50%;
        transform: translateX(-50%);
      }
      .nav-link {
        transition: .3s linear;
      }
      .nav-link:hover {
        background-color: #ff383813;
      }
      .nav-link {
        border-radius: 10px;
      }
      .daily-summary {
        background: linear-gradient(to right, var(--fiery-red), var(--fiery-orange));
      }
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.8);
      }
      .modal.show {
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .modal-content {
        background-color: var(--card-bg);
        margin: 15% auto;
        padding: 20px;
        border-radius: 10px;
        width: 90%;
        max-width: 400px;
        position: relative;
      }
      .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        position: absolute;
        right: 15px;
        top: 10px;
      }
      .close:hover,
      .close:focus {
        color: var(--fiery-red);
        text-decoration: none;
        cursor: pointer;
      }
      .loading {
        display: none;
        color: var(--fiery-orange);
      }
      .loading.show {
        display: inline-block;
      }
      .error {
        color: #ff6b6b;
        font-size: 14px;
        margin-top: 5px;
      }
    </style>
</head>
<body class="bg-[var(--dark-bg)] text-white antialiased scroll-smooth">
    <div class="container">
        <div class="card bg-[var(--card-bg)] p-5">
            <div class="head flex items-center justify-between mb-6">
                <div>
                    <h1 class="font-poppins text-2xl font-bold text-[var(--fiery-orange)]">Meal Tracker</h1>
                </div>
            </div>
            
            <!-- Breakfast -->
            <div class="calories-card bg-[var(--dark-bg)] p-6 rounded-lg w-full mb-5" data-meal="breakfast">
                <div class="top flex items-center justify-between w-full">
                    <h2 class="font-poppins text-xl">Breakfast</h2>
                    <span class="calories-number font-bold text-gray-400">0</span>
                </div>
                <div class="food-items">
                    <p class="text-gray-400 mt-2">No items logged yet</p>
                </div>
                <div class="flex items-center mt-3 gap-2 text-[var(--fiery-red)] cursor-pointer add-food-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus w-4 h-4"><path d="M5 12h14"></path><path d="M12 5v14"></path></svg>
                    <span>Add Food</span>
                </div>
            </div>

            <!-- Lunch -->
            <div class="calories-card bg-[var(--dark-bg)] p-6 rounded-lg w-full mb-5" data-meal="lunch">
                <div class="top flex items-center justify-between w-full">
                    <h2 class="font-poppins text-xl">Lunch</h2>
                    <span class="calories-number font-bold text-gray-400">0</span>
                </div>
                <div class="food-items">
                    <p class="text-gray-400 mt-2">No items logged yet</p>
                </div>
                <div class="flex items-center mt-3 gap-2 text-[var(--fiery-red)] cursor-pointer add-food-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus w-4 h-4"><path d="M5 12h14"></path><path d="M12 5v14"></path></svg>
                    <span>Add Food</span>
                </div>
            </div>

            <!-- Dinner -->
            <div class="calories-card bg-[var(--dark-bg)] p-6 rounded-lg w-full mb-5" data-meal="dinner">
                <div class="top flex items-center justify-between w-full">
                    <h2 class="font-poppins text-xl">Dinner</h2>
                    <span class="calories-number font-bold text-gray-400">0</span>
                </div>
                <div class="food-items">
                    <p class="text-gray-400 mt-2">No items logged yet</p>
                </div>
                <div class="flex items-center mt-3 gap-2 text-[var(--fiery-red)] cursor-pointer add-food-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus w-4 h-4"><path d="M5 12h14"></path><path d="M12 5v14"></path></svg>
                    <span>Add Food</span>
                </div>
            </div>

            <!-- Snacks -->
            <div class="calories-card bg-[var(--dark-bg)] p-6 rounded-lg w-full mb-5" data-meal="snacks">
                <div class="top flex items-center justify-between w-full">
                    <h2 class="font-poppins text-xl">Snacks</h2>
                    <span class="calories-number font-bold text-gray-400">0</span>
                </div>
                <div class="food-items">
                    <p class="text-gray-400 mt-2">No items logged yet</p>
                </div>
                <div class="flex items-center mt-3 gap-2 text-[var(--fiery-red)] cursor-pointer add-food-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus w-4 h-4"><path d="M5 12h14"></path><path d="M12 5v14"></path></svg>
                    <span>Add Food</span>
                </div>
            </div>

            <!-- Daily Summary -->
            <div class="daily-summary rounded-lg p-4 text-white mb-5">
                <h3 class="text-lg font-semibold mb-2">Daily Summary</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <span class="text-sm opacity-90">Total Calories</span>
                        <div class="text-2xl font-bold total-calories">0</div>
                    </div>
                    <div>
                        <span class="text-sm opacity-90">Goal</span>
                        <div class="goal-cal text-2xl font-bold">0</div>
                    </div>
                </div>
            </div>
            <div class="reset-btn flex justify-center">
                <button class="bg-[var(--fiery-red)] text-white py-2 px-4 rounded hover:opacity-90 transition-opacity">Reset</button>
            </div>
        </div>
    </div>

    <!-- Add Food Modal -->
    <div id="foodModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 class="text-xl font-bold text-[var(--fiery-orange)] mb-4">Add Food Item</h2>
            <form id="foodForm">
                <div class="mb-4">
                    <label for="foodInput" class="block text-sm font-medium mb-2">Food Item</label>
                    <input type="text" id="foodInput" class="w-full p-3 rounded bg-[var(--dark-bg)] text-white border border-gray-600 focus:border-[var(--fiery-orange)] outline-none" placeholder="e.g., 1 medium apple, 100g chicken breast" required>
                    <div class="text-xs text-gray-400 mt-1">Be specific with quantities (e.g., "1 cup rice", "200g salmon")</div>
                </div>
                <div class="error-message text-red-500 text-sm mb-4 hidden"></div>
                <div class="flex gap-3">
                    <button type="submit" class="flex-1 bg-gradient-to-r from-[var(--fiery-red)] to-[var(--fiery-orange)] text-white py-2 px-4 rounded hover:opacity-90 transition-opacity">
                        <span class="btn-text">Calculate & Add</span>
                        <span class="loading">Calculating...</span>
                    </button>
                    <button type="button" id="cancelBtn" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 transition-colors">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- NAVBAR -->
    <div class="nav bg-[var(--dark-bg)] p-4 z-50">
        <div class="flex items-center justify-between px-4 gap-2">
            <a href="/home.html">
                <div class="nav-link text-gray-400 flex items-center justify-center flex-col font-poppins rounded p-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-home w-6 h-6 mb-1"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                    <span class="text-xs">Home</span>
                </div>
            </a>
            <a href="/meals.html">
                <div class="nav-link flex items-center justify-center flex-col font-poppins bg-[var(--fiery-red-bg)] p-2 rounded">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-utensils w-6 h-6 mb-1 text-[var(--fiery-red)]"><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"></path><path d="M7 2v20"></path><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"></path></svg>
                    <span class="text-xs text-[var(--fiery-red)]">Meals</span>
                </div>
            </a>
            <a href="/water.html">
                <div class="nav-link text-gray-400 flex items-center justify-center flex-col font-poppins rounded p-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-droplets w-6 h-6 mb-1"><path d="M7 16.3c2.2 0 4-1.83 4-4.05 0-1.16-.57-2.26-1.71-3.19S7.29 6.75 7 5.3c-.29 1.45-1.14 2.84-2.29 3.76S3 11.1 3 12.25c0 2.22 1.8 4.05 4 4.05z"></path><path d="M12.56 6.6A10.97 10.97 0 0 0 14 3.02c.5 2.5 2 4.9 4 6.5s3 3.5 3 5.5a6.98 6.98 0 0 1-11.91 4.97"></path></svg>
                    <span class="text-xs">Water</span>
                </div>
            </a>
            <a href="/workout.html">
                <div class="nav-link text-gray-400 flex items-center justify-center flex-col font-poppins rounded p-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-dumbbell w-6 h-6 mb-1"><path d="M14.4 14.4 9.6 9.6"></path><path d="M18.657 21.485a2 2 0 1 1-2.829-2.828l-1.767 1.768a2 2 0 1 1-2.829-2.829l6.364-6.364a2 2 0 1 1 2.829 2.829l-1.768 1.767a2 2 0 1 1 2.828 2.829z"></path><path d="m21.5 21.5-1.4-1.4"></path><path d="M3.9 3.9 2.5 2.5"></path><path d="M6.404 12.768a2 2 0 1 1-2.829-2.829l1.768-1.767a2 2 0 1 1-2.828-2.829l2.828-2.828a2 2 0 1 1 2.829 2.828l1.767-1.768a2 2 0 1 1 2.829 2.829z"></path></svg>
                    <span class="text-xs">Workout</span>
                </div>
            </a>
        </div>
    </div>

   <script>
    // Add your Gemini API key here
    const GEMINI_API_KEY = "AIzaSyCaBlBUP1smZljC2c22_KPq--GTQApSpxA"; // ðŸ”‘ Replace with your actual Gemini API key

    async function getCalories(foodItem) {
        // Try Gemini AI first (primary method)
        try {
            const geminiResult = await getGeminiCalories(foodItem);
            if (geminiResult) {
                console.log(`${foodItem} â†’ ${geminiResult} cal (from Gemini AI)`);
                return geminiResult;
            }
        } catch (error) {
            console.log('Gemini AI failed:', error);
        }

        // Fallback to USDA API
        try {
            const usdaResult = await getUSDACalories(foodItem);
            if (usdaResult) {
                console.log(`${foodItem} â†’ ${usdaResult} cal (from USDA)`);
                return usdaResult;
            }
        } catch (error) {
            console.log('USDA failed:', error);
        }

        // Fallback to CalorieNinjas API
        try {
            const ninjaResult = await getCalorieNinjasCalories(foodItem);
            if (ninjaResult) {
                console.log(`${foodItem} â†’ ${ninjaResult} cal (from CalorieNinjas)`);
                return ninjaResult;
            }
        } catch (error) {
            console.log('CalorieNinjas failed:', error);
        }

        // Final fallback to estimation
        const estimatedResult = estimateCalories(foodItem);
        console.log(`${foodItem} â†’ ${estimatedResult} cal (estimated)`);
        return estimatedResult;
    }

    // Gemini AI API function
    async function getGeminiCalories(foodItem) {
        if (!GEMINI_API_KEY || GEMINI_API_KEY === "YOUR_GEMINI_API_KEY_HERE") {
            console.log('Gemini API key not configured');
            return null;
        }

        const prompt = `Calculate the approximate calories for: ${foodItem}

Please provide ONLY a number representing the calories per 100g or standard serving size. 
If it's a prepared dish, estimate based on typical ingredients and portions.
If you cannot determine the calories, respond with "unknown".

Examples:
- Apple: 52
- Chicken breast: 165
- Rice (cooked): 130
- Pizza slice: 285`;

        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    contents: [{
                        parts: [{
                            text: prompt
                        }]
                    }],
                    generationConfig: {
                        temperature: 0.1,
                        maxOutputTokens: 50,
                    }
                })
            });

            if (!response.ok) {
                throw new Error(`Gemini API request failed: ${response.status}`);
            }

            const data = await response.json();
            
            if (data.candidates && data.candidates[0]?.content?.parts?.[0]?.text) {
                const text = data.candidates[0].content.parts[0].text.trim();
                
                // Extract number from response
                const calorieMatch = text.match(/\d+/);
                if (calorieMatch && text.toLowerCase() !== 'unknown') {
                    const calories = parseInt(calorieMatch[0]);
                    // Validate reasonable calorie range (5-2000 calories)
                    if (calories >= 5 && calories <= 2000) {
                        return calories;
                    }
                }
            }
            
            return null;
        } catch (error) {
            console.error('Gemini API error:', error);
            throw error;
        }
    }

    let goalCal = document.querySelector(".goal-cal");
    goalCal.textContent = localStorage.getItem("Calories") || "2000"; // Default goal if not set

    let days = JSON.parse(localStorage.getItem("days")) || 0;
    let sumCalories = JSON.parse(localStorage.getItem("weekCalories")) || 0;

    let resetBtn = document.querySelector(".reset-btn button");
    resetBtn.addEventListener("click", () => {
        if (days < 6) {
            sumCalories += JSON.parse(localStorage.getItem("TotalCalories")) || 0;
            days++;
        } else {
            days = 0;
            sumCalories = JSON.parse(localStorage.getItem("TotalCalories")) || 0;
        }

        localStorage.setItem("weekCalories", sumCalories);
        localStorage.setItem("days", days);

        localStorage.removeItem("mealData");
        location.reload();
    });

    // Load meals from localStorage
    let meals = JSON.parse(localStorage.getItem('mealData')) || {
        breakfast: { items: [], total: 0 },
        lunch: { items: [], total: 0 },
        dinner: { items: [], total: 0 },
        snacks: { items: [], total: 0 }
    };

    let currentMeal = '';

    // Modal elements
    const modal = document.getElementById('foodModal');
    const form = document.getElementById('foodForm');
    const foodInput = document.getElementById('foodInput');
    const errorMessage = document.querySelector('.error-message');
    const btnText = document.querySelector('.btn-text');
    const loading = document.querySelector('.loading');
    const closeBtn = document.querySelector('.close');
    const cancelBtn = document.getElementById('cancelBtn');

    // Add event listeners to all "Add Food" buttons
    document.querySelectorAll('.add-food-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const mealCard = e.target.closest('.calories-card');
            currentMeal = mealCard.dataset.meal;
            openModal();
        });
    });

    // Modal functions
    function openModal() {
        modal.classList.add('show');
        foodInput.value = '';
        errorMessage.classList.add('hidden');
        errorMessage.textContent = '';
    }
    function closeModal() {
        modal.classList.remove('show');
    }
    closeBtn.onclick = closeModal;
    cancelBtn.onclick = closeModal;
    window.onclick = function (event) {
        if (event.target == modal) closeModal();
    }

    // Form submission
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const foodItem = foodInput.value.trim();
        if (!foodItem) return;

        btnText.style.display = 'none';
        loading.classList.add('show');
        errorMessage.classList.add('hidden');

        try {
            const calories = await getCalories(foodItem);
            addFoodToMeal(currentMeal, foodItem, calories);
            closeModal();
        } catch (error) {
            console.error('Error:', error);
            showError('Failed to calculate calories. Please try again or enter manually.');
        } finally {
            btnText.style.display = 'inline';
            loading.classList.remove('show');
        }
    });

    // USDA API (fallback method)
    async function getUSDACalories(foodItem) {
        const API_KEY = "S0uLHyzfsEIXqm3a01sXPHFeSXEDmFlnYOfJggS8"; // USDA key
        const response = await fetch(`https://api.nal.usda.gov/fdc/v1/foods/search?query=${encodeURIComponent(foodItem)}&api_key=${API_KEY}`);

        if (!response.ok) throw new Error("USDA request failed");
        const data = await response.json();

        if (data.foods && data.foods.length > 0) {
            const food = data.foods[0];
            if (food.foodNutrients) {
                const calorieNutrient = food.foodNutrients.find(n =>
                    n.nutrientId === 1008 || n.nutrientName.toLowerCase().includes('energy')
                );
                if (calorieNutrient?.value) return Math.round(calorieNutrient.value);
            }
        }
        return null;
    }

    // CalorieNinjas API (fallback method)
    async function getCalorieNinjasCalories(foodItem) {
        const API_KEY = null; // ðŸ”‘ Add your key or leave null
        if (!API_KEY) return null;

        const response = await fetch(`https://api.calorieninjas.com/v1/nutrition?query=${encodeURIComponent(foodItem)}`, {
            headers: { 'X-Api-Key': API_KEY }
        });

        if (!response.ok) throw new Error("CalorieNinjas request failed");
        const data = await response.json();

        if (data.items && data.items.length > 0) {
            return Math.round(data.items[0].calories);
        }
        return null;
    }

    // Estimate calories (final fallback)
    function estimateCalories(foodItem) {
        const lowerFood = foodItem.toLowerCase();
        const calorieEstimates = {
            'apple': 52, 'banana': 89, 'orange': 47, 'grape': 67,
            'chicken breast': 165, 'salmon': 208, 'tuna': 144,
            'rice': 130, 'bread': 79, 'pasta': 131,
            'egg': 155, 'milk': 42, 'yogurt': 59,
            'potato': 77, 'carrot': 41, 'broccoli': 34,
            'cheese': 113, 'butter': 717, 'olive oil': 884,
            'almonds': 576, 'peanuts': 567, 'walnuts': 654,
            'pizza': 285, 'burger': 354, 'sandwich': 200,
            'salad': 20, 'soup': 80, 'cake': 350
        };

        for (const [food, calories] of Object.entries(calorieEstimates)) {
            if (lowerFood.includes(food)) return calories;
        }
        return 100; // Default estimate
    }

    // Add food to meal
    function addFoodToMeal(mealType, foodName, calories) {
        meals[mealType].items.push({ name: foodName, calories });
        meals[mealType].total += calories;
        localStorage.setItem('mealData', JSON.stringify(meals));
        updateMealDisplay(mealType);
        updateTotalCalories();
        checkCalorieGoal();
    }

    // Update meal display
    function updateMealDisplay(mealType) {
        const mealCard = document.querySelector(`[data-meal="${mealType}"]`);
        const foodItems = mealCard.querySelector('.food-items');
        const caloriesNumber = mealCard.querySelector('.calories-number');

        foodItems.innerHTML = meals[mealType].items.length === 0
            ? '<p class="text-gray-400 mt-2">No items logged yet</p>'
            : meals[mealType].items.map(item =>
                `<div class="flex items-center mt-3 gap-2">
                    âœ… <span class="text-gray-400">${item.name} <small>(${item.calories} cal)</small></span>
                </div>`
            ).join('');

        caloriesNumber.textContent = meals[mealType].total;
    }

    // Update total daily calories
    function updateTotalCalories() {
        const totalCalories = Object.values(meals).reduce((sum, meal) => sum + meal.total, 0);
        document.querySelector('.total-calories').textContent = totalCalories;
        localStorage.setItem('TotalCalories', totalCalories);
    }

    // Check if calorie goal is reached
    function checkCalorieGoal() {
        const goal = parseInt(localStorage.getItem("Calories")) || 2000;
        const totalCalories = Object.values(meals).reduce((sum, meal) => sum + meal.total, 0);
        document.querySelectorAll('.add-food-btn').forEach(btn => {
            btn.style.display = totalCalories >= goal ? 'none' : 'inline-flex';
        });
    }

    // Show error message
    function showError(message) {
        errorMessage.textContent = message;
        errorMessage.classList.remove('hidden');
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        Object.keys(meals).forEach(mealType => updateMealDisplay(mealType));
        updateTotalCalories();
        checkCalorieGoal();
    });
</script>

</body>
</html>